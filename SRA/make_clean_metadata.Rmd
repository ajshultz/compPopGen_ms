## Notes

For each species, manual curation is necessary to produce a usable sample sheet (in most cases). These are processing notes on each species.

At the moment, there is no automated way to add assembly / publication data for each metadata file, and so this is manually tracked via Google Sheet, here

### Setup

First we load libraries

```{r}
library(rvest)
library(stringr)
library(tabulizer)
library(readxl)
library(tidyverse)

```

Then we set some default processing. For all datasets, we need the BioProject (to link to publication), the BioSample (to link to VCF), and Organism. 

Paths for input and output:

```{r}
clean_metadata_path <- "~/Projects/popgen/compPopGen_ms/SRA/cleaned-metadata/"
raw_metadata_path <- "~/Projects/popgen/compPopGen_ms/SRA/SRA-sample-metadata/"
```

A genome key file that links reference species to GenBank accession:

```{r}
genome_key_file <- "~/Projects/popgen/compPopGen_ms/SRA/Organism_Metadata.tsv"
genome_key <- read_tsv(file=genome_key_file)
```

Functions for reading and writing metadata:

```{r}

get_sra <- function(sp, path=raw_metadata_path, opt_cols) {
  default_cols = c("BioProject", "BioSample", "Organism", "sex")
  if (missing(opt_cols)) {
    cols = enquo(default_cols)
  } else {
    default_cols = c(default_cols, opt_cols)
    cols = enquo(default_cols)
  }
  read_tsv(str_c(raw_metadata_path, "SRA_Metadata_", sp, ".tsv")) %>% 
    select(!!cols)
}

write_metadata <- function(df, refSp) {
  refGenome <- genome_key %>% filter(Organism == refSp) %>% pull(AssemblyAccession)
  df %>% mutate(refGenome = refGenome) %>%
  split(., .$Organism) %>%
  imap(~ write_csv(as.data.frame(.x), file = str_c(clean_metadata_path, .y, '_metadata.csv')))
}
  
```

## METADATA CODE BELOW ##

### Amphilophus citrinellus

Sample metadata downloaded from: https://datadryad.org/stash/dataset/doi:10.5061/dryad.bcc2fqz91

Keyed on sample it / submitter id.


```{r}
sp<-"Amphilophus_citrinellus"
bp<-"PRJEB38173"

#metadata from paper
dryad_link<-"https://datadryad.org/stash/downloads/file_stream/561311"
paper<-read_csv(dryad_link) %>% select(Sample_name, Species, Lake, Sampling_Year)

sra<-get_sra(sp, opt_cols = c("Submitter_Id")) %>%
  mutate(Submitter_Id = str_remove(Submitter_Id, "_WGS")) %>% 
  inner_join(paper,by=c("Submitter_Id" = "Sample_name")) %>%
  mutate(Organism = case_when(
    Species == "Amphilophus cf. citrinellus" ~ "Amphilophus spp",
    Species == "Amphilophus spp. (hybrid)" ~ "Amphilophus spp",
    TRUE ~ Species
   )) %>%
  select(-Species) %>%
  mutate(Organism = str_replace_all(Organism, " ", "_"))

write_metadata(sra, "GCA_013435755.1")
```

### Anas platyrhynchos

Sample metadata embedded in PDF in supplemental material: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6050300/bin/41467_2018_4868_MOESM1_ESM.pdf

Location of mallard sampling taken from paper text.

```{r}
sp="Anas_platyrhynchos"
sra<-get_sra(sp, opt_cols = c("Sample_Type", "sex")) %>% 
  mutate(Sample_Type = str_remove(Sample_Type, "_F"))

supmat<-"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6050300/bin/41467_2018_4868_MOESM1_ESM.pdf"
paper<-do.call(rbind,extract_tables(supmat, pages=c(38:40)))
colnames(paper) <- c("sample", "breed", "mapping_rate", "insert_size", "depth")

paper %>% as_tibble %>% select(sample, breed) %>% 
  filter(breed != "Breed", breed != "") %>% 
  left_join(sra, by=c("sample" = "Sample_Type")) %>%
  filter(breed == "Mallard") %>%
  mutate(Continent = "Asia", Country = "China", Locality = "Aoji Duck Farm, Zhejiang Province") %>%
  write_csv(str_c(clean_metadata_path, sp, "_meta.csv"))
```

### Anguilla anguilla

Metadata provided to SRA is great and totally complete, no need to dig into paper.
Generally this is very low coverage data, with only a fraction of individuals above 5x, so may not be great.
Closely related species Anguilla rostrata also available

```{r}
sp="Anguilla_anguilla"

sra<-get_sra(sp, opt_cols = c("Isolate", "Ecotype", "Collection_date", "lat_lon", 
                              "geo_loc_name_country", "geo_loc_name_country_continent", 
                              "geo_loc_name")) %>%
  rename(Country=geo_loc_name_country, 
         Continent=geo_loc_name_country_continent,
         Locality=geo_loc_name) %>% 
    write_csv(str_c(clean_metadata_path, sp, "_meta.csv"))
```

### Anolis carolinensis

Single individuals of A. porcatus and A. allisoni in same BioProject.

Metadata is okay, but need to get more info about location from the paper: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6681179/

Locked in a Zip archive so need to process

```{r}
sp="Anolis_carolinensis"

sra<-get_sra(sp, opt_cols = c("Sample Name", "Sample_Type")) %>% 
  rename(Submitter_Id = `Sample Name`, Isolate = Sample_Type)

supmat<-"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6681179/bin/evz110_supplementary_data.zip"
temp <- tempfile()
download.file(supmat,temp)
unzip(temp, files=c("Table_S1.xlsx"), junkpaths=TRUE, exdir=raw_metadata_path)
paper<-read_excel(str_c(raw_metadata_path, "Table_S1.xlsx")) %>% select(Sample:Longitude)
unlink(temp)

inner_join(paper, sra, by=c("Sample" = "Submitter_Id")) %>% 
  write_csv(str_c(clean_metadata_path, sp, "_meta.csv"))
```

### Astatotilapia calliptera

This dataset is complex, spanning many species in the cichild flock. Best to process by BioProject, not species. The metadata is also terrible and poorly organized / hard to parse.

Will need to think a bit about whether this is usable, but the metadata is here if needed.

```{r}
sp="Astatotilapia_calliptera"
bp="PRJEB1254"

sra<-get_sra(bp, opt_cols = c("Alias")) %>% 
  rename(Submitter_Id = Alias)

supmat1<-"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4700518/bin/NIHMS66047-supplement-01.pdf"
table16<-do.call(rbind,extract_tables(supmat1, pages=c(47:47)))
colnames(table16) <- c("SampleName", "BioSample")

paper1<-as_tibble(table16) %>% separate_rows(BioSample, sep=",") %>% filter(SampleName != "Samples") %>%
  filter(BioSample != "") %>%
  separate_rows(BioSample, sep=",") %>%
  mutate(BioSample = str_remove(BioSample, "\\r")) %>%
  mutate(BioSample = trimws(BioSample)) %>%
  mutate(BioSample = split_biosample(BioSample)) %>%
  separate_rows(BioSample) %>% select(BioSample, SampleName) %>%
  mutate(BioSample = str_c("SAMEA", BioSample))

supmat2<-"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6443041/bin/NIHMS82209-supplement-Supplementary_information.pdf"
table4 <- do.call(rbind,extract_tables(supmat2, pages=c(50:50)))
colnames(table4) <- c("SampleName", "BioSample")

paper2<-as_tibble(table4) %>% filter(SampleName != "Samples") %>%
  mutate(SampleNameClean = c(rep("Lake Malawi populations",11), rep("Lake Malawi trios",3), 
                        rep("Malawi catchment", 2), rep("Indian ocean catchments", 2),
                        rep("Outgroup", 6))) %>%
  filter(BioSample != "") %>%
  separate_rows(BioSample, sep=",") %>%
  mutate(BioSample = str_remove(BioSample, "A. stuartgranti")) %>%
  mutate(BioSample = str_remove(BioSample, "L. lethrinus")) %>%
  mutate(BioSample = str_remove(BioSample, "A. calliptera Salima")) %>%
  mutate(BioSample = trimws(BioSample)) %>%
  filter(str_detect(BioSample, "SAMEA")) %>%
  mutate(BioSample = str_replace(BioSample, "SAMEA1904329-", "SAMEA1904329-SAMEA1904331")) %>%
  mutate(BioSample = str_replace(BioSample, "SAMEA1904350-", "SAMEA1904350-SAMEA1904353")) %>%
  mutate(BioSample = trimws(BioSample)) %>%
  mutate(BioSample = split_biosample(BioSample)) %>%
  separate_rows(BioSample) %>% select(BioSample, SampleNameClean) %>%
  mutate(BioSample = str_c("SAMEA", BioSample))

full_join(paper1, paper2, by=c("BioSample" = "BioSample")) %>% distinct() %>% 
  full_join(sra, by=c("BioSample" = "BioSample")) %>% distinct() %>%
  rename(SampleName1 = SampleName, SampleName2 = SampleNameClean) %>%
  filter(!is.na(BioProject)) %>%
  write_csv(str_c(clean_metadata_path, bp, "_meta.csv"))
```


### Astyanax mexicanus

Beautiful metadata, everything in SRA submission

```{r}
sp="Astyanax_mexicanus"
  
sra<-get_sra(sp, opt_cols = c("Sample Name")) %>% 
  rename(Submitter_Id = `Sample Name`) %>%
  separate(Submitter_Id, into=c("Population"), remove=FALSE, extra="drop")

sra %>% write_csv(str_c(clean_metadata_path, sp, "_meta.csv"))

```

### Athene cunicularia

SRA submission mostly looks good, although there does not appear to be a way to link the SRA populations (A, B, C) to the real world places they are from.

```{r}

sp="Athene_cunicularia"
  
sra<-get_sra(sp, opt_cols = c("Sample Name", "Ecotype")) %>% 
  rename(Submitter_Id = `Sample Name`) %>%
  separate(Ecotype, into=c("Site", "Site_Type", "Year"), remove=FALSE, extra="drop")

sra %>% write_csv(str_c(clean_metadata_path, sp, "_meta.csv"))
```

### Chaenogobius annularis

Adding information about population defined in the paper (Pacific Ocean vs Sea of Japan). 

Japan:Misaki -> PO
Japan:Misaki -> PO
Japan:Onagawa -> PO
Japan:Onagawa -> PO
Japan:Aomori -> SJ
Japan:Aomori -> SJ
Japan:Aomori -> SJ
Japan:Murakami -> SJ
Japan:Murakami -> SJ
Japan:Murakami -> SJ
Japan:Misaki -> PO
Japan:Onagawa -> PO

(from Table S4 from the paper)

```{r}

sp="Chaenogobius_annularis"
  
sra<-get_sra(sp, opt_cols = c("Isolate", "Collection_date", "geo_loc_name_country", "geo_loc_name_country_continent", "geo_loc_name", "Sample_Name")) %>% 
  rename(Submitter_Id = Sample_Name, Country = geo_loc_name_country, Continent = geo_loc_name_country_continent, Locality = geo_loc_name) %>%
  mutate(Population = case_when(
    Locality == "Japan:Misaki" | Locality == "Japan:Onagawa" ~ "Pacific Ocean",
    Locality == "Japan:Aomori" | Locality == "Japan:Murakami" ~ "Sea of Japan"    
  ))

sra %>% write_csv(str_c(clean_metadata_path, sp, "_meta.csv"))

```


### Chloebia gouldiae

Very nice SRA metadata

```{r}

sp="Chloebia_gouldiae"
  
sra<-get_sra(sp, opt_cols = c("Ecotype", "Collection_date", "geo_loc_name_country", "geo_loc_name_country_continent", "geo_loc_name", "lat_lon", "Strain", "Cultivar")) %>% 
  rename(Submitter_Id = Cultivar, Country = geo_loc_name_country, Continent = geo_loc_name_country_continent, Locality = geo_loc_name) %>%
  select(-sex) %>%
  rename(sex = Strain)

sra %>% write_csv(str_c(clean_metadata_path, sp, "_meta.csv"))

```

### Clupea spp.

Complicated by the fact that different metadata fields are used for different BioProjects; will probably need to parse by BioProject and then combined to avoid lots of complicated case_when statements.

Parse by BioProject, then output by species.

Additional metadata could be added froom "meta1" and "meta2" tables, but it is a confusing mess and I haven't done this yet.


```{r}

#PRJNA642736 filter to keep only Sample_Type == "individual"

sra1<-get_sra("PRJNA642736", opt_cols = c("Library Name", "Ecotype", "Sample_Type")) %>% 
  rename(Submitter_Id = `Library Name`, Locality = Ecotype) %>%
  filter(Sample_Type == "individual") %>%
  select(-Sample_Type) %>% select(Organism, BioProject, BioSample, sex, Submitter_Id, Locality)

temp <- tempfile()
supmat<- "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7738190/bin/elife-61076-supp2.xlsx"
download.file(supmat,temp)
meta1<-read_excel(temp, skip=1, col_types = "text", trim_ws = TRUE) 
unlink(temp)

#PRJNA338612 filter to keep only Sample_Type == "individual"

#grab pop info from paper

paper2<-"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5410801/pdf/pnas.201617728.pdf"
table1 <- extract_tables(paper2, pages=c(3:3))[[2]]
colnames(table1) <- c("Locality", "N", "blank", "lat", "lon", "salinity", "date", "spawn_season")
meta2<-as_tibble(table1) %>% 
  filter(date != "") %>% 
  select(-blank, -N) %>% 
  separate(Locality, into=c("Locality", "Population"), remove=FALSE, sep="[†*]") %>% 
  mutate(Population = trimws(str_replace(Population, "[Ww]", ""))) %>%
  mutate(Population = str_replace(Population, "[Ä]", "A"))

sra2<-get_sra("PRJNA338612", opt_cols = c("Sample Name", "Sample_Type")) %>% 
  rename(Submitter_Id = `Sample Name`) %>%
  filter(Sample_Type == "Individual DNA") %>%
  select(-Sample_Type) %>% separate(Submitter_Id, into=c("Population", "Sample"), sep=-1, remove=FALSE) %>%
  left_join(meta2, by=c("Population" = "Population")) %>% select(Organism, BioProject, BioSample, sex, Submitter_Id, Locality)

sra3<-get_sra("PRJNA356817", opt_cols = c("Sample Name")) %>% 
  rename(Submitter_Id = `Sample Name`) %>%
  mutate(Locality = case_when(
    Submitter_Id == "AAPF" | Submitter_Id == "AAPM" ~ "Norway:Bergen",
    Submitter_Id == "ABPF" | Submitter_Id ==  "ABPM" ~ "Sweden:Hästskär",
    TRUE ~ NA_character_)) %>%
    filter(!is.na(Locality))  %>% select(Organism, BioProject, BioSample, sex, Submitter_Id, Locality)

#export
bind_rows(sra1, sra2, sra3) %>% 

```

### Coilia nasus



```{r}

sp="Coilia_nasus"



```





